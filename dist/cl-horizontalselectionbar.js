define(["jquery","underscore","qlik","ng!$q","ng!$http","./properties","./initialproperties","client.utils/state","objects.backend-api/field-api","./lib/js/extensionUtils","./lib/js/moment","./lib/js/daterangepicker","general.models/library/dimension","text!./lib/css/style.css","text!./lib/css/daterangepicker.css","text!./lib/partials/template.html","./lib/js/clTouch","./lib/js/onLastRepeatDirective"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){"use strict";function q(a){var b=k().utcOffset();return 86400*(a-25568)-b}function r(a,b){return k(q(a),"X").utc().format(b)}function s(a,c){var d;return a&&(d=b.isNumber(Number(a))&&Number(a)<1e5?r(a,c):k(a,c,!1).format(c)),d}var t=window.location.pathname.substr(0,window.location.pathname.toLowerCase().lastIndexOf("/sense/app/"));return t&&"/"!=t.substr(0,1)&&(t="/"+t),n=n.replace(new RegExp("__VirtualProxyPrefix__","g"),t),j.addStyleToHeader(n),j.addStyleToHeader(o),{definition:f,initialProperties:g,snapshot:{canTakeSnapshot:!0},support:{"export":!0,exportData:!1},getDropFieldOptions:function(a,b,c,d){d()},getDropDimensionOptions:function(a,b,c,d){d()},getDropMeasureOptions:function(a,b,c,d){d()},resize:function(b,c){this.$scope.setSizeMode(b),a(".qv-card"&&!c.showTitles)?a(".qv-object-cl-horizontalselectionbar").find("header.thin").addClass("no-title"):a(".qv-object-cl-horizontalselectionbar").find("header.thin").removeClass("no-title")},paint:function(b,d){this.$scope.setSizeMode(b);var e=c.currApp();e.getObjectProperties(d.qInfo.qId).then(function(){}),a(".qv-card"&&!d.showTitles)?a(".qv-object-cl-horizontalselectionbar").find("header.thin").addClass("no-title"):a(".qv-object-cl-horizontalselectionbar").find("header.thin").removeClass("no-title"),this.$scope.setFields(d.kfLists),this.$scope.props=d.props,this.$scope.initSelectionsApplied||this.$scope.setInitSelections(),this.$scope.qId=d.qInfo.qId},template:p,controller:["$scope","$element","$timeout",function(d,e){var f=c.currApp();d.selections={field:"",swipe_idx_min:-1,swipe_idx_max:-1,values_to_select:[],selectionMode:""},d.$on("onRepeatLast",function(){a("[id^=daterangepicker-container-"+d.qId+"]").remove(),b.each(d.fields,function(b){if("DATERANGE"==b.type){var c="daterangepicker-container-"+d.qId+"-"+b.id,e="daterange-"+d.qId+"-"+b.id;0==a("#"+c).length&&a("body").append('<div id="'+c+'" class="bootstrap-horizontalselectionbar" style="position: absolute"></div>');var f=b.dateToday,g=b.dateFormat,h=function(a,c){d.selectDateFromAndTo(b.field,a.format(g),c.format(g),!0)},i=k(f).endOf("month").format(g)==k(f).format(g),j=i?[k(f).subtract(11,"month").startOf("month"),k(f).endOf("month")]:[k(f).subtract(12,"month").startOf("month"),k(f).subtract(1,"month").endOf("month")],l={showDropdowns:!0,ranges:{Yesterday:[k(f),k(f)],"Last 7 Days":[k(f).subtract(6,"days"),k(f)],"Last 14 Days":[k(f).subtract(13,"days"),k(f)],"Last 28 Days":[k(f).subtract(27,"days"),k(f)],"Month to Date":[k(f).startOf("month"),k(f)],"Last Month":[k(f).subtract(1,"month").startOf("month"),k(f).subtract(1,"month").endOf("month")],"Year to Date":[k(f).startOf("year"),k(f)],"Rolling 12 months":j},locale:{format:g,firstDay:1},alwaysShowCalendars:!1,parentEl:"#"+c};null!=b.dateStart&&null!=b.dateEnd&&(l.startDate=b.dateStart,l.endDate=b.dateEnd),null!=b.dateMin&&null!=b.dateMax&&(l.minDate=b.dateMin,l.maxDate=b.dateMax),a("#"+e).daterangepicker(l,h),a("#"+c+" div").first().css("display","inline-flex")}})}),d.resolutionBreakpoint={width:1024,height:35,xsmallheight:25},d.sizeMode="",d.fields=[],d.variables=[],d.willApplyInitSelections=!1,d.initSelectionsApplied=!1,d.sessionStorageId=d.$parent.layout.qExtendsId?d.$parent.layout.qExtendsId:d.$parent.layout.qInfo.qId,d.setSizeMode=function(b){d.sizeMode=a(document).width()<=d.resolutionBreakpoint.width|a(b).height()<=d.resolutionBreakpoint.height?a(b).height()<=d.resolutionBreakpoint.xsmallheight?"X-SMALL":"SMALL":""},d.getSizeMode=function(){return a(document).width()<=d.resolutionBreakpoint.width|a(e).height()<=d.resolutionBreakpoint.height?a(e).height()<=d.resolutionBreakpoint.xsmallheight?"X-SMALL":"SMALL":""},d.getClass=function(){return h.isInAnalysisMode()?"":"no-interactions"},d.setFields=function(c){var e=[];b.each(c,function(c,d){var f=c.qListObject.qDataPages[0]?c.qListObject.qDataPages[0].qMatrix:[];switch(c.listType){case"FIELD":e.push({field:c.qListObject.qDimensionInfo.qGroupFieldDefs[0],type:c.listType,id:d,visible:c.listVisible,initSelection:c.initSelection,initSelectionSeparator:c.initSelectionSeparatorComma?",":c.initSelectionSeparator,label:c.label,data:f});break;case"VARIABLE":for(var g=c.variableValues?a.map(c.variableValues.split(","),a.trim):[],h=[],i=0;i<g.length;i++)h.push({value:g[i]});e.push({variable:c.variable,variableValue:c.variableValue,id:d,type:c.listType,visible:c.listVisible,initSelection:c.initSelection,label:c.label,data:h});break;case"FLAG":var h=[];b.each(f,function(a){var b=a[0].qText.replace(" ","-"),c=a;c.icon=t+"/Extensions/cl-HorizontalSelectionBar/lib/images/flags/"+b+".png",h.push(c)}),e.push({field:c.qListObject.qDimensionInfo.qGroupFieldDefs[0],type:c.listType,id:d,visible:c.listVisible,initSelection:c.initSelection,initSelectionSeparator:c.initSelectionSeparatorComma?",":c.initSelectionSeparator,label:c.label,data:h});break;case"DATERANGE":var j="",l=null,m=null,n=c.date.format,o="DEFAULT"===c.date.displayFormat?n:c.date.displayFormat,p=s(c.date.rangeMin,n),q=s(c.date.rangeMax,n),r=s(c.date.initSelectionFrom,n),u=s(c.date.initSelectionTo,n),v=isNaN(c.date.today)?k():s(c.date.today,n),w=!1;s(c.date.rangeMin,n),c.qListObject.qDimensionInfo.qStateCounts.qSelected>0?(c.qListObject.qDimensionInfo.qStateCounts.qSelected<c.date.max-c.date.min+1&&(w=!0),l=s(c.date.min,n),m=s(c.date.max,n),j=s(c.date.min,o)+" - "+s(c.date.max,o)):j="Select a date range",e.push({field:c.qListObject.qDimensionInfo.qGroupFieldDefs[0],type:c.listType,id:d,visible:c.listVisible,dateFromInitSelection:r,dateToInitSelection:u,dateFormat:n,displayDateFormat:o,displayText:j,isNotARange:w,dateStart:l,dateEnd:m,dateToday:v,dateMin:p,dateMax:q,label:c.label,data:f});break;default:this.$scope.fields[d]=null}}),d.fields=e},d.selectValue=function(a,b,c,e){a.ctrlKey?d.selectFieldValues(b,[d.getValue(c)],!1):d.selectFieldValues(b,[d.getValue(c)],e)},d.selectElemNo=function(a,b,c,e){a.ctrlKey?d.selectElemNos(b,[c],!1,!1):d.selectElemNos(b,[c],e,!1)},d.selectElemNos=function(a,b,c){var e="/kfLists/"+a+"/qListObjectDef";d.ext.model.enigmaModel.selectListObjectValues(e,b,c,!1)},d.selectDateFromAndTo=function(a,b,c,d){a="="==a.substring(0,1)?a.substring(1,a.length):a,f.field(a).selectMatch(">="+b+"<="+c,d).then(function(){})},d.selectFieldValues=function(a,c,d){a="="==a.substring(0,1)?a.substring(1,a.length):a;var e=[];b.each(c,function(a){e.push(JSON.parse(a))}),f.field(a).selectValues(e,d).then(function(){})["catch"](function(){location.reload(!0)})},d.setVariable=function(a,b){f.variable.setStringValue(a,b).then(function(){})},d.getValue=function(a){return JSON.stringify(isNaN(a.qNum)?{qText:a.qText}:a.qNum)},d.showField=function(a){return a.visible&&!b.isEmpty(a.data)},d.changeAlternativeDimensions=function(a,b,c,d){f.getObject(d).then(function(d){var e=[{qOp:"replace",qPath:"qHyperCubeDef/qDimensions/0",qValue:JSON.stringify(b)},{qOp:"replace",qPath:"qHyperCubeDef/qLayoutExclude/qHyperCubeDef/qDimensions/"+c,qValue:JSON.stringify(a)}];d.clearSoftPatches(),d.applyPatches(e,!0)})},d.prepareAlternativeDimension=function(a){var e=c.navigation.getCurrentSheetId();f.getObject(e.sheetId).then(function(c){var e=[];b.each(c.layout.cells,function(a){"linechart"==a.type&&e.push(a.name)}),b.each(e,function(c){f.getObjectProperties(c).then(function(e){f.getObject(c).then(function(f){if(f.clearSoftPatches(),e.properties.qHyperCubeDef.qLayoutExclude.qHyperCubeDef.qDimensions&&e.properties.qHyperCubeDef.qLayoutExclude.qHyperCubeDef.qDimensions.length>0){var g=e.properties.qHyperCubeDef.qDimensions[0];b.each(e.properties.qHyperCubeDef.qLayoutExclude.qHyperCubeDef.qDimensions,function(b,e){b.qLibraryId?m.getProperties(b.qLibraryId).then(function(f){a==f.properties.qDim.title&&d.changeAlternativeDimensions(g,b,e,c)}):b.qDef.qFieldLabels[0]==a&&d.changeAlternativeDimensions(g,b,e,c)})}})})})})},d.checkInitSelections=function(){var a=JSON.parse(sessionStorage.getItem(d.sessionStorageId)),b=a?a.selectionApplied:!1;b&&"ON_SHEET"!=d.layout.props.initSelectionMode||(d.willApplyInitSelections=!0)},d.setInitSelections=function(){if(d.willApplyInitSelections){b.each(d.fields,function(a,c){if("VARIABLE"!=a.type&&"DATERANGE"!=a.type&&""!=a.initSelection){var e=["=","<",">"];if(e.indexOf(a.initSelection.substring(0,1))>-1)f.field(a.field).clear(),f.field(a.field).selectMatch(a.initSelection);else{var g=a.initSelection.split(a.initSelectionSeparator),h=[];b.each(g,function(a){h.push(isNaN(a)?'{"qText": "'+a+'"}':a)}),d.selectFieldValues(a.field,h,!1)}}"VARIABLE"==a.type&&""!=a.initSelection&&d.setVariable(a.variable,a.initSelection),"DATERANGE"==a.type&&""!=a.dateFromInitSelection&&""!=a.dateToInitSelection&&d.selectDateFromAndTo(a.field,a.dateFromInitSelection,a.dateToInitSelection,!1)});var a={selectionApplied:!0};sessionStorage.setItem(d.sessionStorageId,JSON.stringify(a))}d.initSelectionsApplied=!0,d.willApplyInitSelections=!1},d.checkInitSelections(),d.onActivate=function(){},d.onSwipeStart=function(b){var c=a(b.target),e=a(b.target).index(),f=c.attr("field");d.selections.swipe_idx_min=e,d.selections.swipe_idx_max=e,d.selections.field=f;var g=parseInt(c.attr("datavalue"));d.selections.selectionsMode=!c.hasClass("S"),"undefined"!=typeof g&&(d.selections.selectionsMode?(d.selections.values_to_select.push(g),c.removeClass("A X O"),c.addClass("S")):(d.selections.values_to_select.push(g),c.removeClass("S"),c.addClass("X")))},d.onSwipeUpdate=function(b){var c=a(b.originalEvent.target),e=c.attr("field");if(e==d.selections.field){var f=a(b.originalEvent.target).index(),g=d.selections.swipe_idx_min>f||d.selections.swipe_idx_max<f;if(g){d.selections.swipe_idx_min=d.selections.swipe_idx_min>f?f:d.selections.swipe_idx_min,d.selections.swipe_idx_max=d.selections.swipe_idx_max<f?f:d.selections.swipe_idx_max;var h=a(b.originalEvent.target.parentElement.children);h.slice(d.selections.swipe_idx_min,d.selections.swipe_idx_max+1).each(function(){var b=this;if(d.selections.selectionsMode){if(!a(b).hasClass("S")){var c=parseInt(a(b).attr("datavalue"));-1==d.selections.values_to_select.indexOf(c)&&"undefined"!=typeof c&&(d.selections.values_to_select.push(c),a(b).removeClass("A X O"),a(b).addClass("S"))}}else if(a(b).hasClass("S")){var c=parseInt(a(b).attr("datavalue"));-1==d.selections.values_to_select.indexOf(c)&&"undefined"!=typeof c&&(d.selections.values_to_select.push(c),a(b).removeClass("S"),a(b).addClass("X"))}})}}},d.onSwipeCancel=function(a){},d.onSwipe=function(){d.selections.swipe_idx_min=-1,d.selections.swipe_idx_max=-1,d.selections.values_to_select!=[]&&(d.selectElemNos(d.selections.field,d.selections.values_to_select,!0),d.selections.values_to_select=[]),d.selections.field=""}}]}});