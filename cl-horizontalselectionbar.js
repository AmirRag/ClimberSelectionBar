define(["jquery","underscore","qlik","translator","qvangular","angular","./properties","./initialproperties","client.utils/state","general.utils/responsive-state","objects.backend-api/field-api","./lib/js/extensionUtils","./lib/js/moment","./lib/js/daterangepicker","general.models/library/dimension","text!./lib/css/style.css","text!./lib/css/daterangepicker.css","text!./lib/partials/template.html","./lib/js/clTouch","./lib/js/onLastRepeatDirective"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r){"use strict";function s(a){var b=25568,c=86400,d=(a-b)*c;return d}function t(a){var b=m().utcOffset();return b===-0?a.subtract(1,"d"):b>=0?a.subtract(b,"m"):a.add(b,"m")}function u(a,b,c){return c?m.unix(s(a)).utc().format(b):t(m.unix(s(a)).utc()).format(b)}function v(a,c,d){var e;return a&&(e=b.isNumber(Number(a))&&Number(a)<1e5?u(a,c,d):d?m.utc(a,c,!1).format(c):m(a,c,!1).format(c)),e}var w=e.getService("$q"),x=window.location.pathname.substr(0,window.location.pathname.toLowerCase().lastIndexOf("/sense/app/"));return x&&"/"!==x.substr(0,1)&&(x="/"+x),p=p.replace(new RegExp("__VirtualProxyPrefix__","g"),x),l.addStyleToHeader(p),l.addStyleToHeader(q),{definition:g,initialProperties:h,thinHeader:!0,snapshot:{canTakeSnapshot:!0},support:{"export":!0,exportData:!0},resize:function(a,b){this.paint(a,b)},paint:function(b,c){var d=c.qInfo.qId,e=this;a(".qv-card"&&!c.showTitles)?a(".qv-object-cl-horizontalselectionbar").find("header.thin").addClass("no-title"):a(".qv-object-cl-horizontalselectionbar").find("header.thin").removeClass("no-title"),this.$scope.props=c.props,this.$scope.qId=c.qInfo.qId,void 0!==c.props.canTakeSnapshot&&(this.$scope.$parent.ext.snapshot.canTakeSnapshot=c.props.canTakeSnapshot),void 0===c.props.canMaximize||c.props.canMaximize?a('div[tid="'+d+'"] .qv-object-cl-horizontalselectionbar .lui-icon--expand').css("display","inherit"):a('div[tid="'+d+'"] .qv-object-cl-horizontalselectionbar .lui-icon--expand').css("display","none");var f=w.defer();return e.$scope.paintPromise=f,e.$scope.paintPromise.promise},template:r,controller:["$scope","$element","$timeout","$window",function(e,g,h,k){e.enigmaModel=e.component.model.hasOwnProperty("enigmaModel")?e.component.model.enigmaModel:e.component.model,e.options={},e.qId=-1;var l=c.currApp(e.ext);"App"!==l.model.constructor.name&&(l=c.currApp());var n;n=l?l.model.layout.qLocaleInfo:{qCalendarStrings:{qDayNames:["må","ti","on","to","fr","lö","sö"],qMonthNames:["jan","feb","mar","apr","may","jun","jul","aug","sep","oct","nov","dec"]},qFirstWeekDay:0,qCollation:"sv-SE",qDateFmt:"YYYY-MM-DD"};var p=b.clone(n.qCalendarStrings.qDayNames);p.unshift(p.pop());var q=(n.qFirstWeekDay+1)%7;e.format={CollationLocale:n.qCollation,DateFormat:n.qDateFmt,MonthNames:n.qCalendarStrings.qMonthNames,FirstWeekDay:q,DayNames:p},e.selections={field:"",swipe_idx_min:-1,swipe_idx_max:-1,values_to_select:[],selectionMode:""};var r=m.localeData();m.updateLocale(r._abbr,{week:{dow:e.format.FirstWeekDay,doy:r._week.doy}});var s=function(){a("[id^=daterangepicker-container-"+e.qId+"]").remove()},t=function(){a("[id^=daterangepicker-container-"+e.qId+"]").children(".daterangepicker").hide()};j.ViewChanged.bind(t),e.$on("$destroy",function(){s()}),e.$on("onRepeatLast",function(){s(),b.each(e.fields,function(c){if("DATERANGE"===c.type){var f="daterangepicker-container-"+e.qId+"-"+c.id,g="daterange-"+e.qId+"-"+c.id;0===a("#"+f).length&&a("body").append('<div id="'+f+'" class="bootstrap-horizontalselectionbar" style="position: absolute"></div>');var h=c.dateToday,i=function(a,b){e.selectDateFromAndTo(c.field,a.format(e.format.DateFormat),b.format(e.format.DateFormat),!0)},j={showDropdowns:!0,singleDatePicker:c.singleDatePicker,locale:{format:e.format.DateFormat,firstDay:e.format.FirstWeekDay,monthNames:e.format.MonthNames,daysOfWeek:e.format.DayNames,applyLabel:d.get("Common.Apply"),cancelLabel:d.get("Common.Cancel"),customRangeLabel:c.customRangeLabel},alwaysShowCalendars:c.alwaysShowCalendars,parentEl:"#"+f};null!=c.dateStart&&null!=c.dateEnd&&(j.startDate=c.dateStart,j.endDate=c.dateEnd),null!=c.dateMin&&null!=c.dateMax&&(j.minDate=c.dateMin,j.maxDate=c.dateMax),c.dateRanges&&(j.ranges={},b.each(c.dateRanges,function(a){var b=m(h).endOf("month").format(e.format.DateFormat)===m(h).format(e.format.DateFormat);switch(a.value){case"TODAY":j.ranges[a.label]=[m(h),m(h)];break;case"YESTERDAY":j.ranges[a.label]=[m(h).subtract(1,"days"),m(h).subtract(1,"days")];break;case"LAST07DAYS":j.ranges[a.label]=[m(h).subtract(6,"days"),m(h)];break;case"LAST14DAYS":j.ranges[a.label]=[m(h).subtract(13,"days"),m(h)];break;case"LAST28DAYS":j.ranges[a.label]=[m(h).subtract(27,"days"),m(h)];break;case"LAST30DAYS":j.ranges[a.label]=[m(h).subtract(29,"days"),m(h)];break;case"LAST60DAYS":j.ranges[a.label]=[m(h).subtract(59,"days"),m(h)];break;case"LAST90DAYS":j.ranges[a.label]=[m(h).subtract(89,"days"),m(h)];break;case"THISWEEK":j.ranges[a.label]=[m(h).startOf("week"),m(h).endOf("week")];break;case"LASTWEEK":j.ranges[a.label]=[m(h).subtract(1,"week").startOf("week"),m(h).subtract(1,"week").endOf("week")];break;case"THISMONTH":j.ranges[a.label]=[m(h).startOf("month"),m(h).endOf("month")];break;case"LASTMONTH":j.ranges[a.label]=[m(h).subtract(1,"month").startOf("month"),m(h).subtract(1,"month").endOf("month")];break;case"THISQUARTER":j.ranges[a.label]=[m(h).startOf("quarter"),m(h).endOf("quarter")];break;case"LASTQUARTER":j.ranges[a.label]=[m(h).subtract(1,"quarter").startOf("quarter"),m(h).subtract(1,"quarter").endOf("quarter")];break;case"THISYEAR":j.ranges[a.label]=[m(h).startOf("year"),m(h).endOf("year")];break;case"LASTYEAR":j.ranges[a.label]=[m(h).subtract(1,"year").startOf("year"),m(h).subtract(1,"year").endOf("year")];break;case"WTD":j.ranges[a.label]=[m(h).startOf("week"),m(h)];break;case"MTD":j.ranges[a.label]=[m(h).startOf("month"),m(h)];break;case"QTD":j.ranges[a.label]=[m(h).startOf("quarter"),m(h)];break;case"YTD":j.ranges[a.label]=[m(h).startOf("year"),m(h)];break;case"R11":j.ranges[a.label]=[m(h).subtract(10,"month"),m(h)];break;case"R11FM":j.ranges[a.label]=b?[m(h).subtract(10,"month").startOf("month"),m(h).endOf("month")]:[m(h).subtract(11,"month").startOf("month"),m(h).subtract(1,"month").endOf("month")];break;case"R12":j.ranges[a.label]=[m(h).subtract(11,"month"),m(h)];break;case"R12FM":j.ranges[a.label]=b?[m(h).subtract(11,"month").startOf("month"),m(h).endOf("month")]:[m(h).subtract(12,"month").startOf("month"),m(h).subtract(1,"month").endOf("month")]}})),a("#"+g).daterangepicker(j,i),a("#"+f+" div").first().css("display","inline-flex")}}),e.paintPromise.resolve()}),e.resolutionBreakpoint={width:1024,height:35,xsmallheight:30,hideLabelHeight:30},e.fields=[],e.variables=[],e.willApplyInitSelections=!1,e.initSelectionsApplied=!1,e.sessionStorageId=e.$parent.layout.qExtendsId?e.$parent.layout.qExtendsId:e.$parent.layout.qInfo.qId,e.getSizeMode=function(){var b="TOP"===e.layout.props.alignLabel&&e.showLabels()?a(g).height()-10:a(g).height();return a(document).width()<=e.resolutionBreakpoint.width||b<=e.resolutionBreakpoint.height?b<=e.resolutionBreakpoint.xsmallheight?"X-SMALL":"SMALL":""},e.showLabels=function(){return a(g).height()<=e.resolutionBreakpoint.hideLabelHeight&&"TOP"===e.layout.props.alignLabel?!1:e.options.showLabels},e.getClass=function(){var a=[];return j.isSmallDevice||a.push("cl-desktop-container"),i.isInAnalysisMode()||a.push("no-interactions"),e.props&&e.props.floatMode&&a.push(e.props.floatMode),a},e.getCell=function(){const b=a(g).parents(".qv-gridcell")[0],c=f.element(b).scope();return c.cell},e.cell=e.getCell(),e.updateCellStyle=function(){function a(a){e.cell.style=e.cell.style?b.extend(e.cell.style,a):a}j.isSmallDevice&&h(function(){var b=g.find(".cl-inner-container"),c=b.height()+30+"px",d={height:c};a(d)},0)},e.$watch("cell.style",function(){e.updateCellStyle()}),e.$watchCollection("layout.kfLists",function(a){e.setFields(a),e.initSelectionsApplied||e.setInitSelections()}),e.$watch(function(){return g.find(".cl-inner-container").height()},function(){e.updateCellStyle()});var u=f.element(k);u.bind("resize",function(){h()}),e.setFields=function(c){var d=[],f=!1;b.each(c,function(c,g){f=c.showLabels?!0:f;var h=c.showLabels?c.label:"",i=c.qListObject.qDataPages[0]?c.qListObject.qDataPages[0].qMatrix:[];switch(c.listType){case"FIELD":d.push({field:c.qListObject.qDimensionInfo.qGroupFieldDefs[0],type:c.listType,id:g,visible:c.listVisible,initSelection:c.initSelection,initSelectionSeparator:c.initSelectionSeparatorComma?",":c.initSelectionSeparator,label:h,data:i});break;case"VARIABLE":for(var j=c.variableValues?a.map(c.variableValues.split(","),a.trim):[],k=[],l=0;l<j.length;l++)k.push({value:j[l]});d.push({variable:c.variable,variableValue:c.variableValue,id:g,type:c.listType,visible:c.listVisible,initSelection:c.initSelection,label:h,data:k});break;case"FLAG":var n=[];b.each(i,function(a){var b=a[0].qText.replace(" ","-"),c=a;c.icon=x+"/Extensions/cl-HorizontalSelectionBar/lib/images/flags/"+b+".png",n.push(c)}),d.push({field:c.qListObject.qDimensionInfo.qGroupFieldDefs[0],type:c.listType,id:g,visible:c.listVisible,initSelection:c.initSelection,initSelectionSeparator:c.initSelectionSeparatorComma?",":c.initSelectionSeparator,label:h,data:n});break;case"DATERANGE":var o="",p=null,q=null,r=e.format.DateFormat,s="DEFAULT"===c.date.displayFormat?r:c.date.displayFormat,t=v(c.date.rangeMin,r,!0),u=v(c.date.rangeMax,r,!0),w=v(c.date.singleDate?c.date.initSelection:c.date.initSelectionFrom,r),y=v(c.date.singleDate?c.date.initSelection:c.date.initSelectionTo,r),z=isNaN(Number(c.date.today))?v(c.date.today,r,!0):m(),A=c.date.useDateRanges&&!c.date.singleDate?c.date.dateRanges:null,B=c.date.useDateRanges||c.date.singleDate?c.date.alwaysShowCalenders:!0,C=c.date.customRangeLabel,D=!1,E=c.date.singleDate;c.qListObject.qDimensionInfo.qStateCounts.qSelected>0?(c.qListObject.qDimensionInfo.qStateCounts.qSelected<c.date.max-c.date.min+1&&(D=!0),p=v(c.date.min,r),q=v(c.date.max,r),o=E?v(c.date.min,s):v(c.date.min,s)+" - "+v(c.date.max,s)):o=E?c.date.singleDefaultText:c.date.defaultText,d.push({field:c.qListObject.qDimensionInfo.qGroupFieldDefs[0],type:c.listType,id:g,visible:c.listVisible,dateFromInitSelection:w,dateToInitSelection:y,dateFormat:r,displayDateFormat:s,displayText:o,isNotARange:D,dateStart:p,dateEnd:q,dateToday:z,dateMin:t,dateMax:u,label:h,dateRanges:A,alwaysShowCalendars:B,customRangeLabel:C,data:i,singleDatePicker:E});break;case"BUTTON":"LINK"===c.buttonType?d.push({field:c.qListObject.qDimensionInfo.qGroupFieldDefs[0],buttonName:c.labelButton?c.labelButton:c.qListObject.qDimensionInfo.qGroupFieldDefs[0],url:c.linkURL,openType:c.linkOpenType,listType:c.listType,type:c.buttonType,clickType:0!==c.buttonCalculationCondition?"active":"inactive",visible:!0,id:g,label:h,data:c.qListObject.qDimensionInfo.qGroupFieldDefs[0]}):"EXPORT"===c.buttonType&&d.push({field:c.qListObject.qDimensionInfo.qGroupFieldDefs[0],buttonName:c.labelButton?c.labelButton:c.qListObject.qDimensionInfo.qGroupFieldDefs[0],listType:c.listType,exportId:c.exportId,type:c.buttonType,clickType:0!==c.buttonCalculationCondition?"active":"inactive",visible:!0,id:g,label:h,data:c.qListObject.qDimensionInfo.qGroupFieldDefs[0]})}}),e.options.showLabels=f,e.fields=d},e.exportData=function(a,b){"active"===b&&l.getObject(null,a).then(function(a){a.exportData().then(function(a){var b=a.result?a.result.qUrl:a.qUrl;window.open(b,"_blank")})})},e.selectValue=function(a,b,c,d){a.ctrlKey?e.selectFieldValues(b,[e.getValue(c)],!1):e.selectFieldValues(b,[e.getValue(c)],d)},e.selectElemNo=function(a,b,c,d){a.ctrlKey?e.selectElemNos(b,[c],!1,!1):e.selectElemNos(b,[c],d,!1)},e.selectElemNos=function(a,b,c){var d="/kfLists/"+a+"/qListObjectDef";e.enigmaModel.selectListObjectValues(d,b,c,!1)},e.activateLink=function(a,b,c){var d=a;"active"===c&&("NEWWINDOW"===b?window.open(d):"SAMETAB"===b&&window.open(d,"_self"))},e.selectDateFromAndTo=function(a,b,c,d){a="="===a.substring(0,1)?a.substring(1,a.length):a,l.field(a).selectMatch(">="+b+"<="+c,d).then(function(){})},e.selectFieldValues=function(a,c,d){a="="===a.substring(0,1)?a.substring(1,a.length):a;var e=[];b.each(c,function(a){e.push(JSON.parse(a))}),l.field(a).selectValues(e,d)["catch"](function(a){})},e.setVariable=function(a,b){l.variable.setStringValue(a,b).then(function(){})},e.getValue=function(a){return JSON.stringify(isNaN(a.qNum)?{qText:a.qText}:a.qNum)},e.showField=function(a){return a.visible?"BUTTON"===a.listType?!0:b.isEmpty(a.data)?!1:!0:!1},e.changeAlternativeDimensions=function(a,b,c,d){l.getObject(d).then(function(d){var e=[{qOp:"replace",qPath:"qHyperCubeDef/qDimensions/0",qValue:JSON.stringify(b)},{qOp:"replace",qPath:"qHyperCubeDef/qLayoutExclude/qHyperCubeDef/qDimensions/"+c,qValue:JSON.stringify(a)}];d.clearSoftPatches(),d.applyPatches(e,!0)})},e.prepareAlternativeDimension=function(a){var d=c.navigation.getCurrentSheetId();l.getObject(d.sheetId).then(function(c){var d=[];b.each(c.layout.cells,function(a){"linechart"===a.type&&d.push(a.name)}),b.each(d,function(c){l.getObjectProperties(c).then(function(d){l.getObject(c).then(function(f){if(f.clearSoftPatches(),d.properties.qHyperCubeDef.qLayoutExclude.qHyperCubeDef.qDimensions&&d.properties.qHyperCubeDef.qLayoutExclude.qHyperCubeDef.qDimensions.length>0){var g=d.properties.qHyperCubeDef.qDimensions[0];b.each(d.properties.qHyperCubeDef.qLayoutExclude.qHyperCubeDef.qDimensions,function(b,d){b.qLibraryId?o.getProperties(b.qLibraryId).then(function(f){a===f.properties.qDim.title&&e.changeAlternativeDimensions(g,b,d,c)}):b.qDef.qFieldLabels[0]===a&&e.changeAlternativeDimensions(g,b,d,c)})}})})})})},e.checkInitSelections=function(){var a=JSON.parse(sessionStorage.getItem(e.sessionStorageId)),b=a?a.selectionApplied:!1;b&&"ON_SHEET"!==e.layout.props.initSelectionMode||(e.willApplyInitSelections=!0)},e.setInitSelections=function(){if(e.willApplyInitSelections){b.each(e.fields,function(a){if("VARIABLE"!==a.type&&"DATERANGE"!==a.type&&"LINK"!==a.type&&""!==a.initSelection){var c=["=","<",">"];if(c.indexOf(a.initSelection.substring(0,1))>-1)l.field(a.field).clear(),l.field(a.field).selectMatch(a.initSelection);else{var d=[],f=a.initSelection.split(a.initSelectionSeparator?a.initSelectionSeparator:";");b.each(f,function(a){d.push(isNaN(a)?'{"qText": "'+a+'"}':a)}),e.selectFieldValues(a.field,d,!1)}}"VARIABLE"===a.type&&""!==a.initSelection&&e.setVariable(a.variable,a.initSelection),"DATERANGE"===a.type&&""!==a.dateFromInitSelection&&""!==a.dateToInitSelection&&e.selectDateFromAndTo(a.field,a.dateFromInitSelection,a.dateToInitSelection,!1)});var a={selectionApplied:!0};sessionStorage.setItem(e.sessionStorageId,JSON.stringify(a))}e.initSelectionsApplied=!0,e.willApplyInitSelections=!1},e.checkInitSelections(),e.onActivate=function(){},e.onSwipeStart=function(b){var c=a(b.target),d=a(b.target).index(),f=c.attr("field");e.selections.swipe_idx_min=d,e.selections.swipe_idx_max=d,e.selections.field=f;var g=parseInt(c.attr("datavalue"));e.selections.selectionsMode=!c.hasClass("S"),"undefined"!=typeof g&&(e.selections.selectionsMode?(e.selections.values_to_select.push(g),c.removeClass("A X O"),c.addClass("S")):(e.selections.values_to_select.push(g),c.removeClass("S"),c.addClass("X")))},e.onSwipeUpdate=function(b){var c=a(b.originalEvent.target),d=c.attr("field");if(d===e.selections.field){var f=a(b.originalEvent.target).index(),g=e.selections.swipe_idx_min>f||e.selections.swipe_idx_max<f;if(g){e.selections.swipe_idx_min=e.selections.swipe_idx_min>f?f:e.selections.swipe_idx_min,e.selections.swipe_idx_max=e.selections.swipe_idx_max<f?f:e.selections.swipe_idx_max;var h=a(b.originalEvent.target.parentElement.children);h.slice(e.selections.swipe_idx_min,e.selections.swipe_idx_max+1).each(function(){var b=this;if(e.selections.selectionsMode){if(!a(b).hasClass("S")){var c=parseInt(a(b).attr("datavalue"));-1===e.selections.values_to_select.indexOf(c)&&"undefined"!=typeof c&&(e.selections.values_to_select.push(c),a(b).removeClass("A X O"),a(b).addClass("S"))}}else if(a(b).hasClass("S")){var d=parseInt(a(b).attr("datavalue"));-1===e.selections.values_to_select.indexOf(d)&&"undefined"!=typeof d&&(e.selections.values_to_select.push(d),a(b).removeClass("S"),a(b).addClass("X"))}})}}},e.onSwipeCancel=function(){},e.onSwipe=function(){e.selections.swipe_idx_min=-1,e.selections.swipe_idx_max=-1,e.selections.values_to_select!==[]&&(e.selectElemNos(e.selections.field,e.selections.values_to_select,!0),e.selections.values_to_select=[]),e.selections.field=""}}]}});